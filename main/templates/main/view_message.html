{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <style>
        body {
            background: #1f1f20;
            color: white;
            overflow: hidden;
          }
          
          .nav-logo {
            color: rgba(233, 11, 233, 0.973);
            font-size: xx-large;
            font-weight: bolder;
            font-family: serif;
          }
          
          .nav-logo:hover {
            color: white;
          }
          
          .navbar.bg-body-tertiary {
            background-color: transparent !important;
            color: white;
          }
          
          .signbtn {
            background-color: #e90ccb;
            color: rgb(5, 5, 5);
            border-radius: 15px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
          }
          
          .signbtn:hover {
            background-color: #050100;
            color: rgb(236, 22, 208);
          }
          
          .content-1 {
            /* border: 1px solid rgba(61, 5, 5, 1); */
            height: 90vh;
          }
          
          .content-1b {
            border: 1px solid #1f1f20;
            height: 100vh;
            /* width: 70vh; */
          }
          
          .content-1a {
            border: 2px solid #1f1f20;
            height: 90vh;
          }
          
          .content-1a ul li {
            list-style: none;
            margin: 30px 18px;
            font-size: x-large;
            font-weight: 600;
            border-radius: 30px;
            padding-left: 20px;
            padding-top: 5px;
            height: 8vh;
            background: none;
          }
          
          /* .content-1 li:nth-child(1) {
              width: 10vw;
              background: hsl(0, 82%, 29%);
          }
          
          .content-1a li:nth-child(2):hover {
              width: 12vw;
              background: hsl(0, 92%, 50%);
          }
          
          .content-1a li:nth-child(3):hover {
              width: 12vw;
              background: hsla(0, 88%, 49%, 0.932);
          }
          
          .content-1a li:nth-child(4):hover {
              width: 17vw;
              background: hsl(0, 90%, 49%);
          }
          
          .content-1a li:nth-child(5):hover {
              width: 12vw;
              background: hsl(0, 98%, 48%);
          } */
          
          /* .content-1a ul li:hover{
              background-color: #bf321d;
              border-radius: 30px;
          } */
          
          /* .content-1a ul li i {
              margin-right: 10px;
          } */
          
          /*end of content-1a*/
          .content-1a ul {
            list-style-type: none;
            padding: 0;
          }
          
          .content-1a li {
            display: flex;
            align-items: center;
            color: rgba(233, 11, 233, 0.973);
          
            background-color: transparent;
          
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
          }
          
          .content-1a li:hover {
            background-color: rgba(128, 0, 128, 0.123);
            text-decoration: underline;
          }
          
          .content-1a i.fa-solid {
            font-size: 24px;
            margin-right: 10px;
          }
          
          .content-1a li a {
            color: rgba(233, 11, 233, 0.973);
          
            text-decoration: none;
          }
          
          .content-1a li a:hover {
            text-decoration: underline;
          }
          
          .search-container {
            display: flex;
            align-items: center;
            border: 1px solid #901a9b;
            border-radius: 7px;
            width: 300px;
            margin-top: 5%;
            padding: 5px;
            position: relative;
          }
          
          .search-input {
            height: 7vh;
            flex-grow: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: hsla(0, 0%, 53%, 0.04);
            color: #ccc;
            padding-left: 30px;
          }
          
          .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #c426a9;
            font-size: 18px;
          }
          
          /*End of search*/
          
          /*trending topics*/
          .trending {
            margin-top: 10%;
          }
          
          .trending-heading {
            margin-top: 5%;
            font-weight: bolder;
          }
          
          .trending-topics {
            padding: 2%;
          }
          
          .trends {
            padding-left: 10px;
          }
          
          .t1 {
            margin-bottom: 3%;
          }
          
          .t1 a {
            font-weight: bold;
            text-decoration: none;
            color: rgb(29, 155, 240);;
          }
          
          .t1 a:hover {
            text-decoration: underline;
          }
          
          /*col-6*/
          
          .msgbox {
            display: flex;
            margin-top: 3%;
          }
          
          .msgbox-input {
            display: flex;
            /* border: 3px solid grey; */
            width: 48vw;
            margin-top: 6px;
          }
          
          .msgbox-input input {
            width: 44vw;
            background: hsla(0, 0%, 53%, 0.04);
            outline: none;
            border: none;
            color: white;
            padding-left: 20px;
            border-radius: 30px;
          }
          
          .msgbox-img {
            min-width: 40px;
            width: 40px;
            height: 40px;
            margin-right: 10px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #f8f8fa;
          }
          
          .msgbox-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius:50%;
          }
          
          .msg-con {
            display: flex;
            border-bottom: 2px solid #1f1f20;
            height: 10vh;
            /* justify-content: flex-end; */
          }
          
          .msgbox-btn {
            background-color: #f1e8f1;
            color: #901a9b;
            border-radius: 30px;
            width: 7vw;
            height: 6vh;
            margin-left: auto;
            margin-right: 14px;
            font-weight: bold;
          }
          
          .msgbox-btn:hover {
            background-color: #901a9b;
            color: white;
            border-radius: 30px;
          }
          
          .msgbox-btn2 {
            border-radius: 50%;
            width: 3vw;
            height: 6vh;
            background-color: #1f1f20;
            /* background: transparent;  */
            border: none;
            color: white;
            margin-right: 10px;
          }
          
          .msgbox-btn2:first-child {
            margin-left: 11%;
          }
          
          /*start*/
          
          /* Container for the entire message output */
          .msg-output, .reply-output {
            display: flex;
            margin-top: 1%;
            align-items: flex-start;
          }
          
          /* Style for the user or sender's profile image */
          /* .msg-output-img, .reply-output-img {
              width: 5%;
              min-width: 40px;
              height: auto;
              margin-right: 10px;
              border-radius: 40%;
              overflow: hidden;
          } */
          .msg-output, .reply-output {
            display: flex;
            margin-top: 1%;
            align-items: flex-start;
          }
          
          .msg-output-img, .reply-output-img {
            min-width: 40px;
            width: 40px;
            height: 40px;
            margin-right: 10px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #f8f8fa;  
          }
          
          .msg-output-img img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 50%;
          }
          .reply-output-img img{
            max-width: 100%;
            max-height: 100%;
            border-radius: 50%;
          }
          
          /* Style for the message details container */
          .msg-output-details, .reply-output-details {
            flex-grow: 1;
            color: #f8f8fa;
          }
          
          .msg-output-details h5 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
          }
          .reply-output-details h5{
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
          }
          
          .msg-output-details p {
            font-size: 14px;
            margin: 0;
          }
          .reply-output-details p{
            font-size: 14px;
            margin: 0;
          }
          
          /* Additional styles for timestamp or metadata */
          .msg-output-details .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
          }
          .reply-output-details .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
          }
          .msg-output-details img{
            width: auto;
            height: auto;
            max-width: 100%;
            margin-top: 5px;
            border-radius: 2%;
          }
          
          .reply-output-details img{
            width: auto;
            height: auto;
            max-width: 100%;
            margin-top: 5px;
            border-radius: 2%;
          }
          
          
          /* Style for links in messages */
          .msg-output-details a {
            color: #0077cc;
            /* Change to your preferred link color */
            text-decoration: underline;
          }
          reply-output-details a {
            color: #0077cc;
            text-decoration: underline;
          }
          
          .msg-output-details a:hover {
            text-decoration: none;
          }

          .reply-output-details a:hover {
            text-decoration: none;
          }
          
          /*end  #1f1f20 */
          .msg-output-main, .reply-output-main {
            border-top: 1px solid #1b1b1c;
            border-bottom: 1px solid #1b1b1c;
          }
          
          .msg-output-icons, .reply-output-icons {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            margin-top: 10px;
            justify-content: space-around;
            height: 4vh;
          }
          
          .msg-output-icons i {
            margin-right: 10px;
            font-size: 15px;
            color: #f7f1f1f5;
          }
          
          .msg-output-icons i:hover {
            cursor: pointer;
            color: #eb11c6;
          }

          .reply-output i {
            font-size: 15px;
            color: #f7f1f1f5;
          }
          
          .reply-output i:hover {
            cursor: pointer;
            color: #eb11c6;
          }
          
          .content-scroll {
            height: 100vh;
            overflow-y: auto;
          }
          
          .content-scroll::-webkit-scrollbar {
            width: 0em;
          }
          
          .content-1b {
            background-color: #1f1f20;
          
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
          }
          
          .content-1b p:first-child {
            font-size: 20px;
            font-weight: bold;
            color: #fffdfd;
          }
          
          .content-1b p:nth-child(2) {
            font-size: 16px;
            color: #dbcece;
          }
          
          .content-1b h3 {
            font-size: 24px;
            margin-top: 20px;
          
            color: #c2b0b0;
          }
          
          .content-1b p {
            font-size: 14px;
            line-height: 1.5;
          
            margin-top: 10px;
          
            color: #ddc6c6;
          }
          
          a {
            color: white;
            text-decoration: none;
          }
          
          #profile_img_navbar:hover {
            cursor: pointer;
          }
          
          #comment:hover {
            cursor: pointer;
          }
          
          #imageContainer {
            width: 50px;
            height: 50px;
          }
          
          
          
          #emoji-picker {
            position: absolute;
            display: none;
          }

          .post-head{
            display:flex;
            align-items:center;
          }
          .post-head h4{
            padding-left:30px;
          }
          .post-head i{
            cursor:pointer;
          }
          .profile-name-1{
            display:flex;
            justify-content:space-between;
            width: 41vw;
          }
          .reply-output-details p{
            margin-bottom: 1vw;
          }

          .msg-output-details p, .reply-output-details p{
            max-width:41vw;
            word-wrap: break-word; 
            box-sizing: border-box;
        }
          
    </style>
    <link rel="stylesheet" href="{% static 'main/css/index.css' %}">
  </head>
  <body>

    <nav class="navbar navbar-expand bg-body-tertiary">
      <div class="container-fluid">
        <!-- <img src="/img/logo2.png" alt=""> -->
        <a class="navbar-brand ms-5 nav-logo" href="{% url 'index' %}"
          >PseudoSpeak</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
          {% if user.is_authenticated %}
          <img
            id="profile_img_navbar"
            src="{{ user.profile.profile_img.url }}"
            alt=""
            style="
              width: 50px;
              height: 50px;
              border-radius: 50%;
              margin-right: 10px;
            "
          />
          <a href="{% url 'logout' %}" class="btn signbtn me-4">Logout</a>
          {% else %}
          <a href="{% url 'login_or_signup_view' %}" class="btn signbtn me-4"
            >Sign in</a
          >
          {% endif %}
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row content-1">
        <div class="col-3 content-1a res2 sidebar" id="sidebar">
          <ul>
            <li class="active">
              <i class="fa-solid fa-house"></i
              ><a href="{% url 'index' %}">Feed</a>
            </li>
            <li>
              <i class="fa-solid fa-user-group"></i
              ><a href="{% url 'rooms' name='recommended' %}">Groups</a>
            </li>
            <li>
              <i class="fa-solid fa-comments"></i
              ><a href="{% url 'messenger' %}">Messenger</a>
            </li>
            <li><i class="fa-solid fa-user-plus"></i>Invite Friends</li>
            <li>
              <i class="fa-solid fa-gear"></i
              ><a href="{% url 'settings' %}">Settings</a>
            </li>
          </ul>
        </div>


        <div class="col-6 content-1b content-scroll">

          <div class="post-head" onclick="previous()">
            <i class="fa-solid fa-chevron-left"></i>
            <h4 style="padding-left: 20px;">View Post</h4>
          </div>

          <div class="msgbox">

            <form>
        
              <!-- sd -->
              <div id="message-output" class="msg-output-main row">
                <div class="msg-output">
                  <div class="msg-output-img">
                    <img src="{{message.user.profile.profile_img.url}}" alt="Profile Picture" id="profile-img" data-img-id="{{message.user.username}}">
                  </div>
                  <div class="msg-output-details">
                    <h5>{{message.user.username}}</h5>
                    <p>{{message.decrypt_message}}</p>
                    {% if message.image %}
                    <img src="{{message.image.url}}" alt="">
                    {% endif %}
                  </div>
                </div>
                <div class="msg-output-icons">
                  <i class="far fa-comment" id="comment" data-message-id="{{message.pk}}"></i>
                  <i class="fa-solid fa-reply"></i>
                  {% if request.user in message.userLiked.all %}
                  <i class="far fa-solid fa-thumbs-up" id="msg-likes" data-likes-id="{{message.pk}}" style="color: #c426a9;">{{message.likes}}</i>
                  {% else %}
                  <i class="far fa-thumbs-up" id="msg-likes" data-likes-id="{{message.pk}}">{{message.likes}}</i>
                  {% endif %}
                  <i class="fa-regular fa-eye" id="views" data-views-id="{{message.pk}}">{{message.view_count}}</i>
                </div>
              </div>
        
              <!-- endd -->


              <div class="msgbox-input">
                <div class="msgbox-img ">
                  <img src="{{request.user.profile.profile_img.url}}" alt="">
                </div>
                <input id="data1" type="text" placeholder="Add a comment...">
              </div>
              <div class="msg-con row">
                <button class="msgbox-btn btn align-self-center" id="post-msg">Reply</button>
              </div>

              <div class="reply-container">
                <div class="reply-heading">
                  <h5>Comments</h5>
                </div>
                <div class="reply-body">
                {% for message in replies %}
                  <div id="reply-output" class="reply-output-main row">
                    <div class="reply-output">
                      <div class="reply-output-img">
                        <img src="{{message.user.profile.profile_img.url}}" alt="Profile Picture" id="profile-img" data-img-id="{{message.user.username}}">
                      </div>
                      <div class="reply-output-details">
                        <div class="profile-name-1">
                          <h5>{{message.user.username}}</h5>
                          {% if request.user in message.userLiked.all %}
                          <i class="fa-solid fa-heart" id="msg-likes" data-likes-id="{{message.pk}}" style="color: #c426a9;"></i>
                          {% else %}
                          <i class="fa-regular fa-heart" id="msg-likes" data-likes-id="{{message.pk}}"></i>
                          {% endif %}
                        </div>
                        <p>{{message.decrypt_message}}</p>
                      </div>
                    </div>
                  </div>

                {% endfor %}
                </div>
              </div>
        
            </form>

          </div>
          <!-- search box -->
        </div>
        
        <div class="col-3 content-1a">
          <div class="search-container">
            <input type="text" name="search-input" class="search-input" id="search-input" placeholder="Search here...">
            <i class="fas fa-search search-icon" id="search-icon"></i>
          </div>
        
          <div class="trending">
            <h4 class="trending-heading">Trending on PseudoSpeak</h4>
            <div class="trending-topics">
              {% for tag in hashtags %}
              <div class="t1">
                <span><i class="fa-solid fa-arrow-trend-up"></i></span>
                <input type="hidden" name="tag" value="{{ tag.tag }}" />
                <a
                  href="#"
                  class="trends"
                  style="cursor: pointer"
                  data-tag="{{tag.tag}}"
                  >{{ tag.tag}}</a
                >
              </div>
              {% endfor %}
        
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://kit.fontawesome.com/76b0e8fe7d.js"
      crossorigin="anonymous"
    ></script>

    {{ room.slug|json_script:"json-roomname" }}
    {{request.user.username|json_script:"json-username" }}
    {{message.id|json_script:"json-messageId"}}
    <script>
        const messageId=parseInt(document.getElementById("json-messageId").textContent);
        const username=document.getElementById("json-username").textContent;
        const replyBtn=document.querySelector("#post-msg");


        function previous(){
          window.history.back();
        }

        console.log(messageId);

        const socket=new WebSocket(
            "ws://" +
            window.location.host +
            "/ws/message/"+messageId+"/"
        );

        socket.onopen=function(){
            console.log("Connection established")
            replyBtn.addEventListener('click',function(event){
                event.preventDefault();
                const inputEle=document.querySelector("#data1");
                const inputData=inputEle.value;
                console.log(inputData);
                inputEle.value="";
                if (inputData.trim()!==""){
                socket.send(JSON.stringify({
                    "messageId":messageId,
                    "content":inputData,
                    "username":username
                }))
            }
            })
            socket.onmessage=function(e){
                data=JSON.parse(e.data)
                console.log(data)
                if (data['content']){
                const template=document.querySelector(".reply-body");
                const container=template.innerHTML;
                template.innerHTML=""
                template.innerHTML=`
                <div id="reply-output" class="reply-output-main row">
                    <div class="reply-output">
                      <div class="reply-output-img">
                        <img src="${data.profile_img}" alt="Profile Picture" id="profile-img" data-img-id="${data.username}">
                      </div>
                      <div class="reply-output-details">
                        <div class="profile-name-1">
                          <h5>${data.username}</h5>
                          <i class="fa-regular fa-heart" data-likes-id="{{message.pk}}" id="msg-likes"></i>
                        </div>
                        <p>${data.content}</p>
                      </div>
                    </div>
                  </div>
                  `
                  template.innerHTML+=container;
                }
            }
        }



      document.querySelector('#profile_img_navbar').onclick = function () {
        const userName = JSON.parse(document.getElementById('json-username').textContent);
        console.log(userName);

        if (userName) {
            var redirectURL = '/dashboard/' + userName + '/';
            window.location.href = redirectURL;
        } else {
            console.error('Username not found.');
        }
    }

    document.body.addEventListener('click', function (e) {
    if (e.target && e.target.id == 'msg-likes') {
        const likedele=e.target
        console.log(likedele)
      const messageID = e.target.getAttribute('data-likes-id');
      const userName = JSON.parse(document.getElementById('json-username').textContent);
      console.log("Message id "+messageID);

      socket.send(JSON.stringify({
        'likeId': messageID,
        'username': username
      }));

      const isLiked = e.target.classList.contains('fa-solid');
      console.log(isLiked)
        // Use the result in your logic
        if (isLiked===true) {
            // The element has the 'liked' class
            // Perform actions for unliking
            e.target.classList.remove('fa-solid');
            e.target.style.color="#fff";
        } else {
            // The element does not have the 'liked' class
            // Perform actions for liking
            e.target.classList.add('fa-solid');
            e.target.style.color="rgba(233, 11, 233, 0.973)";
        }
      
    }
  });

  document.body.addEventListener("click", function (e) {
        // Check if the clicked element has the class 'trends' or 'hashtag'
        if (
          e.target &&
          (e.target.classList.contains("trends") ||
            e.target.classList.contains("hashtag"))
        ) {
          var tag = e.target.getAttribute("data-tag");
          tag = tag.replace("#", ""); // Remove '#' if present
          console.log(tag);
          var redirectURL = "/view_hashtag/message/" + tag + "/";
          window.location.href = redirectURL;
        }
      });
    </script>
  </body>
</html>
